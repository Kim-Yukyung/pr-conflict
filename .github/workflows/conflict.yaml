name: Check PR Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_KEY }}

      - name: Setup
        id: setup
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          echo "jq_available=true" >> $GITHUB_OUTPUT

      - name: Check single PR conflicts
        if: github.event_name == 'pull_request'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_HEAD: ${{ github.event.pull_request.head.ref }}
          PR_BASE: ${{ github.event.pull_request.base.ref }}
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -e
          echo "üîç Checking conflicts for PR #${PR_NUMBER}"
          
          if ! git fetch origin "${PR_BASE}"; then
            echo "‚ùå Failed to fetch base branch"
            exit 1
          fi
          
          MERGE_BASE=$(git merge-base HEAD "origin/${PR_BASE}" 2>/dev/null || echo "")
          if [ -z "$MERGE_BASE" ]; then
            echo "‚ùå Could not find merge base"
            exit 1
          fi
          
          CONFLICTS=$(git merge-tree "$MERGE_BASE" HEAD "origin/${PR_BASE}" | grep -c "<<<<<<< " || echo "0")
          
          if [ "$CONFLICTS" -gt "0" ]; then
            echo "‚ö†Ô∏è Conflicts detected in PR #${PR_NUMBER}"
            
            PAYLOAD=$(jq -n \
              --arg title "‚ö†Ô∏è PR Ï∂©Îèå Î∞úÏÉù!" \
              --arg desc "PRÏóêÏÑú Ï∂©ÎèåÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§." \
              --arg pr_info "[#${PR_NUMBER}](${PR_URL}) ${PR_TITLE}" \
              --arg branch_info "${PR_AUTHOR} | ${PR_HEAD} ‚Üí ${PR_BASE}" \
              --arg url "${PR_URL}" \
              --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
              '{
                embeds: [{
                  title: $title,
                  description: $desc,
                  color: 15158332,
                  fields: [
                    { name: "PR Ï†ïÎ≥¥", value: $pr_info, inline: false },
                    { name: "Î∏åÎûúÏπò Ï†ïÎ≥¥", value: $branch_info, inline: false }
                  ],
                  url: $url,
                  timestamp: $timestamp
                }]
              }')
            
            if ! curl -X POST "${WEBHOOK_URL}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              --fail --silent --show-error; then
              echo "‚ö†Ô∏è Failed to send Discord notification"
            fi
          else
            echo "‚úÖ No conflicts found in PR #${PR_NUMBER}"
          fi

      - name: Check all open PRs conflicts
        if: github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.PAT_KEY }}
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PUSHED_BRANCH: ${{ github.ref_name }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          set -e
          echo "üîç Checking all open PRs after push to ${PUSHED_BRANCH}"
          
          if ! OPEN_PRS=$(gh pr list --state open --base "${PUSHED_BRANCH}" --json number --jq '.[].number'); then
            echo "‚ùå Failed to fetch open PRs"
            exit 1
          fi
          
          if [ -z "$OPEN_PRS" ]; then
            echo "üìù No open PRs found for branch ${PUSHED_BRANCH}"
            exit 0
          fi
          
          CONFLICTED_COUNT=0
          
          check_pr() {
            local PR_NUMBER=$1
            echo "üîç Checking PR #${PR_NUMBER}"
            
            PR_INFO=$(gh pr view "$PR_NUMBER" --json title,url,author,headRefName,baseRefName)
            
            PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
            PR_URL=$(echo "$PR_INFO" | jq -r '.url')
            PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.author.login')
            PR_HEAD=$(echo "$PR_INFO" | jq -r '.headRefName')
            PR_BASE=$(echo "$PR_INFO" | jq -r '.baseRefName')
            
            if ! git fetch origin "refs/pull/${PR_NUMBER}/head:pr-${PR_NUMBER}" 2>/dev/null; then
              echo "‚ö†Ô∏è Failed to fetch PR #${PR_NUMBER}"
              return
            fi
            
            MERGE_BASE=$(git merge-base "pr-${PR_NUMBER}" "origin/${PR_BASE}" 2>/dev/null || echo "")
            
            if [ -n "$MERGE_BASE" ]; then
              CONFLICTS=$(git merge-tree "$MERGE_BASE" "pr-${PR_NUMBER}" "origin/${PR_BASE}" 2>/dev/null | grep -c "<<<<<<< " || echo "0")
              
              if [ "$CONFLICTS" -gt "0" ]; then
                echo "‚ö†Ô∏è Conflicts detected in PR #${PR_NUMBER}: ${PR_TITLE}"
                
                PAYLOAD=$(jq -n \
                  --arg desc "${PUSHED_BRANCH} Î∏åÎûúÏπòÏóê Ìë∏ÏãúÎêú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏúºÎ°ú Ïù∏Ìï¥ PRÏóêÏÑú Ï∂©ÎèåÏù¥ Î∞úÏÉùÌñàÏäµÎãàÎã§." \
                  --arg pr_info "[#${PR_NUMBER}](${PR_URL}) ${PR_TITLE}" \
                  --arg branch_info "${PR_AUTHOR} | ${PR_HEAD} ‚Üí ${PR_BASE}" \
                  --arg commit_msg "${COMMIT_MESSAGE}" \
                  --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
                  '{
                    embeds: [{
                      title: "‚ö†Ô∏è PushÎ°ú Ïù∏Ìïú PR Ï∂©Îèå!",
                      description: $desc,
                      color: 15158332,
                      fields: [
                        { name: "PR Ï†ïÎ≥¥", value: $pr_info, inline: false },
                        { name: "Î∏åÎûúÏπò Ï†ïÎ≥¥", value: $branch_info, inline: false },
                        { name: "Push Ïª§Î∞ã Î©îÏãúÏßÄ", value: $commit_msg, inline: false }
                      ],
                      timestamp: $timestamp
                    }]
                  }')
                
                curl -X POST "${WEBHOOK_URL}" \
                  -H "Content-Type: application/json" \
                  -d "$PAYLOAD" \
                  --fail --silent --show-error || echo "‚ö†Ô∏è Failed to send webhook for PR #${PR_NUMBER}"
                
                return 1
              else
                echo "‚úÖ No conflicts in PR #${PR_NUMBER}"
              fi
            fi
            
            git branch -D "pr-${PR_NUMBER}" 2>/dev/null || true
          }
          
          export -f check_pr
          export GH_TOKEN WEBHOOK_URL PUSHED_BRANCH COMMIT_MESSAGE
          
          echo "$OPEN_PRS" | xargs -I {} -P 5 bash -c 'check_pr "$@"' _ {}
          
          echo "‚úÖ Conflict check completed"
          
