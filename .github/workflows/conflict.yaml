name: Check PR Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check single PR conflicts (for PR events)
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ” Checking conflicts for PR #${{ github.event.pull_request.number }}"
          
          git fetch origin ${{ github.event.pull_request.base.ref }}
          
          # ì¶©ëŒ í™•ì¸
          MERGE_BASE=$(git merge-base HEAD origin/${{ github.event.pull_request.base.ref }})
          CONFLICTS=$(git merge-tree $MERGE_BASE HEAD origin/${{ github.event.pull_request.base.ref }} | grep -c "<<<<<<< " || echo "0")
          
          if [ "$CONFLICTS" -gt "0" ]; then
            echo "âš ï¸ Conflicts detected in PR #${{ github.event.pull_request.number }}"
            
            # ì›¹í›… í˜¸ì¶œ
            curl -X POST "${{ secrets.WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "event_type": "pr_conflict",
                "pr_number": ${{ github.event.pull_request.number }},
                "pr_url": "${{ github.event.pull_request.html_url }}",
                "pr_title": "${{ github.event.pull_request.title }}",
                "pr_author": "${{ github.event.pull_request.user.login }}",
                "base_branch": "${{ github.event.pull_request.base.ref }}",
                "head_branch": "${{ github.event.pull_request.head.ref }}",
                "repository": "${{ github.repository }}"
              }'
          else
            echo "âœ… No conflicts found in PR #${{ github.event.pull_request.number }}"
          fi

      - name: Check all open PRs for conflicts (for push events)
        if: github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Checking all open PRs after push to ${{ github.ref_name }}"
          
          # ëª¨ë“  ì—´ë¦° PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          OPEN_PRS=$(gh api repos/${{ github.repository }}/pulls --jq '.[].number' | tr '\n' ' ')
          
          if [ -z "$OPEN_PRS" ]; then
            echo "ğŸ“ No open PRs found"
            exit 0
          fi
          
          echo "ğŸ“‹ Found open PRs: $OPEN_PRS"
          
          CONFLICTED_PRS=""
          
          for PR_NUMBER in $OPEN_PRS; do
            echo "ğŸ” Checking PR #$PR_NUMBER"
            
            # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            PR_INFO=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
            PR_BASE=$(echo "$PR_INFO" | jq -r '.base.ref')
            PR_HEAD_SHA=$(echo "$PR_INFO" | jq -r '.head.sha')
            PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
            PR_URL=$(echo "$PR_INFO" | jq -r '.html_url')
            PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.user.login')
            
            # í‘¸ì‹œëœ ë¸Œëœì¹˜ê°€ PRì˜ ë² ì´ìŠ¤ ë¸Œëœì¹˜ì™€ ê°™ì€ì§€ í™•ì¸
            if [ "$PR_BASE" != "${{ github.ref_name }}" ]; then
              echo "â­ï¸ Skipping PR #$PR_NUMBER (base: $PR_BASE, pushed: ${{ github.ref_name }})"
              continue
            fi
            
            # PR ë¸Œëœì¹˜ í˜ì¹˜
            git fetch origin pull/$PR_NUMBER/head:pr-$PR_NUMBER
            git checkout pr-$PR_NUMBER
            
            # ì¶©ëŒ í™•ì¸
            MERGE_BASE=$(git merge-base pr-$PR_NUMBER origin/$PR_BASE)
            CONFLICTS=$(git merge-tree $MERGE_BASE pr-$PR_NUMBER origin/$PR_BASE | grep -c "<<<<<<< " || echo "0")
            
            if [ "$CONFLICTS" -gt "0" ]; then
              echo "âš ï¸ Conflicts detected in PR #$PR_NUMBER: $PR_TITLE"
              
              # ì¶©ëŒëœ PR ëª©ë¡ì— ì¶”ê°€
              if [ -z "$CONFLICTED_PRS" ]; then
                CONFLICTED_PRS="$PR_NUMBER"
              else
                CONFLICTED_PRS="$CONFLICTED_PRS,$PR_NUMBER"
              fi
              
              # ê°œë³„ PR ì•ŒëŒ ë°œì†¡
              curl -X POST "${{ secrets.WEBHOOK_URL }}" \
                -H "Content-Type: application/json" \
                -d '{
                  "event_type": "push_caused_conflict",
                  "pr_number": '"$PR_NUMBER"',
                  "pr_url": "'"$PR_URL"'",
                  "pr_title": "'"$PR_TITLE"'",
                  "pr_author": "'"$PR_AUTHOR"'",
                  "base_branch": "'"$PR_BASE"'",
                  "push_author": "${{ github.actor }}",
                  "push_commit": "${{ github.sha }}",
                  "push_message": "${{ github.event.head_commit.message }}",
                  "repository": "${{ github.repository }}"
                }'
            else
              echo "âœ… No conflicts in PR #$PR_NUMBER: $PR_TITLE"
            fi
            
            # ë‹¤ìŒ PR í™•ì¸ì„ ìœ„í•´ ì •ë¦¬
            git checkout ${{ github.ref_name }}
            git branch -D pr-$PR_NUMBER
          done
          
          # ì „ì²´ ìš”ì•½ ì•ŒëŒ (ì¶©ëŒëœ PRì´ ìˆëŠ” ê²½ìš°)
          if [ -n "$CONFLICTED_PRS" ]; then
            echo "ğŸ“Š Summary: Conflicts found in PRs: $CONFLICTED_PRS"
            
            curl -X POST "${{ secrets.WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "event_type": "push_conflict_summary",
                "conflicted_prs": "'"$CONFLICTED_PRS"'",
                "total_conflicted": '"$(echo $CONFLICTED_PRS | tr ',' '\n' | wc -l)"',
                "push_author": "${{ github.actor }}",
                "push_branch": "${{ github.ref_name }}",
                "push_commit": "${{ github.sha }}",
                "push_message": "${{ github.event.head_commit.message }}",
                "repository": "${{ github.repository }}"
              }'
          else
            echo "ğŸ‰ No conflicts found in any open PRs"
          fi
          