name: Check PR Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: Check single PR conflicts (for PR events)
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ” Checking conflicts for PR #${{ github.event.pull_request.number }}"
          
          git fetch origin ${{ github.event.pull_request.base.ref }}
          
          # ì¶©ëŒ í™•ì¸
          MERGE_BASE=$(git merge-base HEAD origin/${{ github.event.pull_request.base.ref }})
          CONFLICTS=$(git merge-tree $MERGE_BASE HEAD origin/${{ github.event.pull_request.base.ref }} | grep -c "<<<<<<< " || echo "0")
          
          if [ "$CONFLICTS" -gt "0" ]; then
            echo "âš ï¸ Conflicts detected in PR #${{ github.event.pull_request.number }}"
            
            # ë””ìŠ¤ì½”ë“œ ì›¹í›… í˜¸ì¶œ
            ESCAPED_TITLE=$(echo "${{ github.event.pull_request.title }}" | sed 's/"/\\"/g')
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"embeds\": [{
                  \"title\": \"âš ï¸ PR ì¶©ëŒ ë°œìƒ!\",
                  \"description\": \"PRì—ì„œ ì¶©ëŒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\",
                  \"color\": 15158332,
                  \"fields\": [
                    {
                      \"name\": \"PR ë²ˆí˜¸\",
                      \"value\": \"#${{ github.event.pull_request.number }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ì œëª©\",
                      \"value\": \"$ESCAPED_TITLE\",
                      \"inline\": false
                    },
                    {
                      \"name\": \"ì‘ì„±ì\",
                      \"value\": \"${{ github.event.pull_request.user.login }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ë² ì´ìŠ¤ ë¸Œëœì¹˜\",
                      \"value\": \"${{ github.event.pull_request.base.ref }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"í—¤ë“œ ë¸Œëœì¹˜\",
                      \"value\": \"${{ github.event.pull_request.head.ref }}\",
                      \"inline\": true
                    }
                  ],
                  \"url\": \"${{ github.event.pull_request.html_url }}\",
                  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                }]
              }"
          else
            echo "âœ… No conflicts found in PR #${{ github.event.pull_request.number }}"
          fi

      - name: Check all open PRs for conflicts (for push events)
        if: github.event_name == 'push'
        run: |
          echo "ğŸ” Checking all open PRs after push to ${{ github.ref_name }}"
          
          # GitHub APIë¡œ ì—´ë¦° PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.PAT || secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&per_page=100")
          
          # API ì‘ë‹µ í™•ì¸
          if echo "$RESPONSE" | grep -q '"message".*"Resource not accessible"'; then
            echo "âŒ API ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ. PATë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”."
            echo "ğŸ” API Response: $RESPONSE"
            exit 1
          fi
          
          # PR ë²ˆí˜¸ ì¶”ì¶œ
          if command -v jq >/dev/null 2>&1; then
            OPEN_PRS=$(echo "$RESPONSE" | jq -r '.[].number' 2>/dev/null | tr '\n' ' ')
          else
            OPEN_PRS=$(echo "$RESPONSE" | grep -o '"number":[0-9]*' | cut -d':' -f2 | tr '\n' ' ')
          fi
          
          if [ -z "$OPEN_PRS" ] || [ "$OPEN_PRS" = " " ]; then
            echo "ğŸ“ No open PRs found"
            exit 0
          fi
          
          echo "ğŸ“‹ Found open PRs: $OPEN_PRS"
          
          CONFLICTED_PRS=""
          CONFLICTED_COUNT=0
          
          for PR_NUMBER in $OPEN_PRS; do
            if [ -z "$PR_NUMBER" ]; then
              continue
            fi
            
            echo "ğŸ” Checking PR #$PR_NUMBER"
            
            # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            PR_INFO=$(curl -s \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${{ secrets.PAT || secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER")
            
            if command -v jq >/dev/null 2>&1; then
              PR_BASE=$(echo "$PR_INFO" | jq -r '.base.ref' 2>/dev/null)
              PR_TITLE=$(echo "$PR_INFO" | jq -r '.title' 2>/dev/null)
              PR_URL=$(echo "$PR_INFO" | jq -r '.html_url' 2>/dev/null)
              PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.user.login' 2>/dev/null)
              PR_HEAD_REF=$(echo "$PR_INFO" | jq -r '.head.ref' 2>/dev/null)
            else
              PR_BASE=$(echo "$PR_INFO" | grep -o '"base":{"[^}]*"ref":"[^"]*"' | sed 's/.*"ref":"\([^"]*\)".*/\1/')
              PR_TITLE=$(echo "$PR_INFO" | grep -o '"title":"[^"]*"' | cut -d'"' -f4)
              PR_URL=$(echo "$PR_INFO" | grep -o '"html_url":"[^"]*"' | cut -d'"' -f4)
              PR_AUTHOR=$(echo "$PR_INFO" | grep -o '"login":"[^"]*"' | head -1 | cut -d'"' -f4)
              PR_HEAD_REF=$(echo "$PR_INFO" | grep -o '"head":{"[^}]*"ref":"[^"]*"' | sed 's/.*"ref":"\([^"]*\)".*/\1/')
            fi
            
            # í‘¸ì‹œëœ ë¸Œëœì¹˜ê°€ PRì˜ ë² ì´ìŠ¤ ë¸Œëœì¹˜ì™€ ê°™ì€ì§€ í™•ì¸
            if [ "$PR_BASE" != "${{ github.ref_name }}" ]; then
              echo "â­ï¸ Skipping PR #$PR_NUMBER (base: $PR_BASE, pushed: ${{ github.ref_name }})"
              continue
            fi
            
            echo "ğŸ“ PR #$PR_NUMBER: $PR_TITLE (by $PR_AUTHOR)"
            
            # PR ë¸Œëœì¹˜ í˜ì¹˜
            if git fetch origin "refs/pull/$PR_NUMBER/head:pr-$PR_NUMBER" 2>/dev/null; then
              git checkout pr-$PR_NUMBER 2>/dev/null
              
              # ì¶©ëŒ í™•ì¸
              if git fetch origin "$PR_BASE" 2>/dev/null; then
                MERGE_BASE=$(git merge-base pr-$PR_NUMBER "origin/$PR_BASE" 2>/dev/null || echo "")
                
                if [ -n "$MERGE_BASE" ]; then
                  CONFLICTS=$(git merge-tree "$MERGE_BASE" pr-$PR_NUMBER "origin/$PR_BASE" 2>/dev/null | grep -c "<<<<<<< " || echo "0")
                  
                  if [ "$CONFLICTS" -gt "0" ]; then
                    echo "âš ï¸ Conflicts detected in PR #$PR_NUMBER: $PR_TITLE"
                    
                    # ì¶©ëŒëœ PR ëª©ë¡ì— ì¶”ê°€
                    if [ -z "$CONFLICTED_PRS" ]; then
                      CONFLICTED_PRS="$PR_NUMBER"
                    else
                      CONFLICTED_PRS="$CONFLICTED_PRS,$PR_NUMBER"
                    fi
                    CONFLICTED_COUNT=$((CONFLICTED_COUNT + 1))
                    
                    # ê°œë³„ PR ë””ìŠ¤ì½”ë“œ ì•ŒëŒ ë°œì†¡
                    ESCAPED_TITLE=$(echo "$PR_TITLE" | sed 's/"/\\"/g')
                    ESCAPED_MESSAGE=$(echo "${{ github.event.head_commit.message }}" | sed 's/"/\\"/g')
                    curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
                      -H "Content-Type: application/json" \
                      -d "{
                        \"embeds\": [{
                          \"title\": \"âš ï¸ Pushë¡œ ì¸í•œ PR ì¶©ëŒ!\",
                          \"description\": \"${{ github.ref_name }} ë¸Œëœì¹˜ì— í‘¸ì‹œëœ ë³€ê²½ì‚¬í•­ìœ¼ë¡œ ì¸í•´ PRì—ì„œ ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\",
                          \"color\": 15105570,
                          \"fields\": [
                            {
                              \"name\": \"ì¶©ëŒëœ PR\",
                              \"value\": \"[#$PR_NUMBER $ESCAPED_TITLE]($PR_URL)\",
                              \"inline\": false
                            },
                            {
                              \"name\": \"PR ì‘ì„±ì\",
                              \"value\": \"$PR_AUTHOR\",
                              \"inline\": true
                            },
                            {
                              \"name\": \"Push ì‘ì„±ì\",
                              \"value\": \"${{ github.actor }}\",
                              \"inline\": true
                            },
                            {
                              \"name\": \"ë² ì´ìŠ¤ ë¸Œëœì¹˜\",
                              \"value\": \"$PR_BASE\",
                              \"inline\": true
                            },
                            {
                              \"name\": \"Push ë©”ì‹œì§€\",
                              \"value\": \"$ESCAPED_MESSAGE\",
                              \"inline\": false
                            }
                          ],
                          \"url\": \"$PR_URL\",
                          \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                        }]
                      }" 2>/dev/null || echo "âš ï¸ Failed to send webhook for PR #$PR_NUMBER"
                  else
                    echo "âœ… No conflicts in PR #$PR_NUMBER: $PR_TITLE"
                  fi
                fi
              fi
              
              # ë‹¤ìŒ PR í™•ì¸ì„ ìœ„í•´ ì •ë¦¬
              git checkout "${{ github.ref_name }}" 2>/dev/null
              git branch -D pr-$PR_NUMBER 2>/dev/null || true
            fi
          done
          
          # ì „ì²´ ìš”ì•½ ì•ŒëŒ (ì¶©ëŒëœ PRì´ ìˆëŠ” ê²½ìš°)
          if [ -n "$CONFLICTED_PRS" ]; then
            echo "ğŸ“Š Summary: Conflicts found in PRs: $CONFLICTED_PRS"
            
            ESCAPED_MESSAGE=$(echo "${{ github.event.head_commit.message }}" | sed 's/"/\\"/g')
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"embeds\": [{
                  \"title\": \"ğŸ“Š ì¶©ëŒ ìš”ì•½\",
                  \"description\": \"${{ github.ref_name }} ë¸Œëœì¹˜ í‘¸ì‹œë¡œ ì¸í•´ ì´ $CONFLICTED_COUNTê°œì˜ PRì—ì„œ ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\",
                  \"color\": 10038562,
                  \"fields\": [
                    {
                      \"name\": \"ì¶©ëŒëœ PR ëª©ë¡\",
                      \"value\": \"$CONFLICTED_PRS\",
                      \"inline\": false
                    },
                    {
                      \"name\": \"Push ì‘ì„±ì\",
                      \"value\": \"${{ github.actor }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ë¸Œëœì¹˜\",
                      \"value\": \"${{ github.ref_name }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ì»¤ë°‹\",
                      \"value\": \"[\`$(echo ${{ github.sha }} | cut -c1-7)\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ì»¤ë°‹ ë©”ì‹œì§€\",
                      \"value\": \"$ESCAPED_MESSAGE\",
                      \"inline\": false
                    }
                  ],
                  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                }]
              }" 2>/dev/null || echo "âš ï¸ Failed to send summary webhook"
          else
            echo "ğŸ‰ No conflicts found in any open PRs"
          fi
