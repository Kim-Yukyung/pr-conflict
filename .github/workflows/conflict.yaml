name: Check PR Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_KEY }}

      - name: Check single PR conflicts (for PR events)
        if: github.event_name == 'pull_request'
        run: |
          echo "üîç Checking conflicts for PR #${{ github.event.pull_request.number }}"
          
          git fetch origin ${{ github.event.pull_request.base.ref }}
          
          # Ï∂©Îèå ÌôïÏù∏
          MERGE_BASE=$(git merge-base HEAD origin/${{ github.event.pull_request.base.ref }})
          CONFLICTS=$(git merge-tree $MERGE_BASE HEAD origin/${{ github.event.pull_request.base.ref }} | grep -c "<<<<<<< " || echo "0")
          
          if [ "$CONFLICTS" -gt "0" ]; then
            echo "‚ö†Ô∏è Conflicts detected in PR #${{ github.event.pull_request.number }}"
            
            ESCAPED_TITLE=$(echo "${{ github.event.pull_request.title }}" | sed 's/"/\\"/g')
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"embeds\": [{
                  \"title\": \"‚ö†Ô∏è PR Ï∂©Îèå Î∞úÏÉù!\",
                  \"description\": \"PRÏóêÏÑú Ï∂©ÎèåÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§.\",
                  \"color\": 15158332,
                  \"fields\": [
                    {
                      \"name\": \"PR Ï†ïÎ≥¥\",
                      \"value\": \"[#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }}) $ESCAPED_TITLE\",
                      \"inline\": false
                    },
                    {
                      \"name\": \"Î∏åÎûúÏπò Ï†ïÎ≥¥\",
                      \"value\": \"${{ github.event.pull_request.user.login }} | ${{ github.event.pull_request.head.ref }} ‚Üí ${{ github.event.pull_request.base.ref }}\",
                      \"inline\": false
                    }
                  ],
                  \"url\": \"${{ github.event.pull_request.html_url }}\",
                  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                }]
              }"
          else
            echo "‚úÖ No conflicts found in PR #${{ github.event.pull_request.number }}"
          fi

      - name: Check all open PRs conflicts (for push events)
        if: github.event_name == 'push'
        run: |
          echo "üîç Checking all open PRs after push to ${{ github.ref_name }}"
          
          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.PAT_KEY }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&per_page=100")
          
          if echo "$RESPONSE" | grep -q '"message".*"Resource not accessible"'; then
            echo "üîç API Response: $RESPONSE"
            exit 1
          fi
          
          if command -v jq >/dev/null 2>&1; then
            OPEN_PRS=$(echo "$RESPONSE" | jq -r '.[].number' 2>/dev/null | tr '\n' ' ')
          else
            OPEN_PRS=$(echo "$RESPONSE" | grep -o '"number":[0-9]*' | cut -d':' -f2 | tr '\n' ' ')
          fi
          
          if [ -z "$OPEN_PRS" ] || [ "$OPEN_PRS" = " " ]; then
            echo "üìù No open PRs found"
            exit 0
          fi
                    
          CONFLICTED_PRS=""
          CONFLICTED_COUNT=0
          
          for PR_NUMBER in $OPEN_PRS; do
            if [ -z "$PR_NUMBER" ]; then
              continue
            fi
            
            echo "üîç Checking PR #$PR_NUMBER"
            
            PR_INFO=$(curl -s \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${{ secrets.PAT_KEY }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER")
            
            if command -v jq >/dev/null 2>&1; then
              PR_BASE=$(echo "$PR_INFO" | jq -r '.base.ref' 2>/dev/null)
              PR_TITLE=$(echo "$PR_INFO" | jq -r '.title' 2>/dev/null)
              PR_URL=$(echo "$PR_INFO" | jq -r '.html_url' 2>/dev/null)
              PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.user.login' 2>/dev/null)
              PR_HEAD_REF=$(echo "$PR_INFO" | jq -r '.head.ref' 2>/dev/null)
            else
              PR_BASE=$(echo "$PR_INFO" | grep -o '"base":{"[^}]*"ref":"[^"]*"' | sed 's/.*"ref":"\([^"]*\)".*/\1/')
              PR_TITLE=$(echo "$PR_INFO" | grep -o '"title":"[^"]*"' | cut -d'"' -f4)
              PR_URL=$(echo "$PR_INFO" | grep -o '"html_url":"[^"]*"' | cut -d'"' -f4)
              PR_AUTHOR=$(echo "$PR_INFO" | grep -o '"login":"[^"]*"' | head -1 | cut -d'"' -f4)
              PR_HEAD_REF=$(echo "$PR_INFO" | grep -o '"head":{"[^}]*"ref":"[^"]*"' | sed 's/.*"ref":"\([^"]*\)".*/\1/')
            fi
            
            if [ "$PR_BASE" != "${{ github.ref_name }}" ]; then
              echo "‚è≠Ô∏è Skipping PR #$PR_NUMBER (base: $PR_BASE, pushed: ${{ github.ref_name }})"
              continue
            fi
                        
            if git fetch origin "refs/pull/$PR_NUMBER/head:pr-$PR_NUMBER" 2>/dev/null; then
              git checkout pr-$PR_NUMBER 2>/dev/null
              
              if git fetch origin "$PR_BASE" 2>/dev/null; then
                MERGE_BASE=$(git merge-base pr-$PR_NUMBER "origin/$PR_BASE" 2>/dev/null || echo "")
                
                if [ -n "$MERGE_BASE" ]; then
                  CONFLICTS=$(git merge-tree "$MERGE_BASE" pr-$PR_NUMBER "origin/$PR_BASE" 2>/dev/null | grep -c "<<<<<<< " || echo "0")
                  
                  if [ "$CONFLICTS" -gt "0" ]; then
                    echo "‚ö†Ô∏è Conflicts detected in PR #$PR_NUMBER: $PR_TITLE"
                    
                    if [ -z "$CONFLICTED_PRS" ]; then
                      CONFLICTED_PRS="$PR_NUMBER"
                    else
                      CONFLICTED_PRS="$CONFLICTED_PRS,$PR_NUMBER"
                    fi
                    CONFLICTED_COUNT=$((CONFLICTED_COUNT + 1))
                    
                    ESCAPED_TITLE=$(echo "$PR_TITLE" | sed 's/"/\\"/g')
                    ESCAPED_MESSAGE=$(echo "${{ github.event.head_commit.message }}" | sed 's/"/\\"/g')
                    curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
                      -H "Content-Type: application/json" \
                      -d "{
                        \"embeds\": [{
                          \"title\": \"‚ö†Ô∏è PushÎ°ú Ïù∏Ìïú PR Ï∂©Îèå!\",
                          \"description\": \"${{ github.ref_name }} Î∏åÎûúÏπòÏóê Ìë∏ÏãúÎêú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏúºÎ°ú Ïù∏Ìï¥ PRÏóêÏÑú Ï∂©ÎèåÏù¥ Î∞úÏÉùÌñàÏäµÎãàÎã§.\",
                          \"color\": 15158332,
                          \"fields\": [
                            {
                              \"name\": \"PR Ï†ïÎ≥¥\",
                              \"value\": \"[#$PR_NUMBER]($PR_URL) $ESCAPED_TITLE\",
                              \"inline\": false
                            },
                            {
                              \"name\": \"Î∏åÎûúÏπò Ï†ïÎ≥¥\",
                              \"value\": \"$PR_AUTHOR | $PR_HEAD_REF ‚Üí $PR_BASE\",
                              \"inline\": false
                            },
                            {
                              \"name\": \"Push Ïª§Î∞ã Î©îÏãúÏßÄ\",
                              \"value\": \"$ESCAPED_MESSAGE\",
                              \"inline\": false
                            }
                          ],
                          \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                        }]
                      }" 2>/dev/null || echo "‚ö†Ô∏è Failed to send webhook for PR #$PR_NUMBER"
                  else
                    echo "‚úÖ No conflicts in PR #$PR_NUMBER: $PR_TITLE"
                  fi
                fi
              fi
              git checkout "${{ github.ref_name }}" 2>/dev/null
              git branch -D pr-$PR_NUMBER 2>/dev/null || true
            fi
          done
          
          if [ -n "$CONFLICTED_PRS" ]; then
            echo "üîç Conflicts detected in $CONFLICTED_COUNT PRs: $CONFLICTED_PRS"
          else
            echo "‚úÖ No conflicts detected in any PRs"
          fi
