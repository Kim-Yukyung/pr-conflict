name: Check PR Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check single PR conflicts (for PR events)
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ” Checking conflicts for PR #${{ github.event.pull_request.number }}"
          
          git fetch origin ${{ github.event.pull_request.base.ref }}
          
          # ì¶©ëŒ í™•ì¸
          MERGE_BASE=$(git merge-base HEAD origin/${{ github.event.pull_request.base.ref }})
          CONFLICTS=$(git merge-tree $MERGE_BASE HEAD origin/${{ github.event.pull_request.base.ref }} | grep -c "<<<<<<< " || echo "0")
          
          if [ "$CONFLICTS" -gt "0" ]; then
            echo "âš ï¸ Conflicts detected in PR #${{ github.event.pull_request.number }}"
            
            # ì›¹í›… í˜¸ì¶œ
            curl -X POST "${{ secrets.WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "event_type": "pr_conflict",
                "pr_number": ${{ github.event.pull_request.number }},
                "pr_url": "${{ github.event.pull_request.html_url }}",
                "pr_title": "${{ github.event.pull_request.title }}",
                "pr_author": "${{ github.event.pull_request.user.login }}",
                "base_branch": "${{ github.event.pull_request.base.ref }}",
                "head_branch": "${{ github.event.pull_request.head.ref }}",
                "repository": "${{ github.repository }}"
              }'
          else
            echo "âœ… No conflicts found in PR #${{ github.event.pull_request.number }}"
          fi

      - name: Check all open PRs for conflicts (for push events)
        if: github.event_name == 'push'
        run: |
          echo "ğŸ” Checking all open PRs after push to ${{ github.ref_name }}"
          
          # GitHub APIë¡œ ì—´ë¦° PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (curl ì‚¬ìš©)
          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&per_page=100")
          
          # jqê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ íŒŒì‹±
          if command -v jq >/dev/null 2>&1; then
            OPEN_PRS=$(echo "$RESPONSE" | jq -r '.[].number' | tr '\n' ' ')
          else
            # jq ì—†ì´ íŒŒì‹± (ê°„ë‹¨í•œ ë°©ë²•)
            OPEN_PRS=$(echo "$RESPONSE" | grep -o '"number":[0-9]*' | cut -d':' -f2 | tr '\n' ' ')
          fi
          
          if [ -z "$OPEN_PRS" ] || [ "$OPEN_PRS" = " " ]; then
            echo "ğŸ“ No open PRs found"
            echo "ğŸ” API Response: $RESPONSE"
            exit 0
          fi
          
          echo "ğŸ“‹ Found open PRs: $OPEN_PRS"
          
          CONFLICTED_PRS=""
          
          for PR_NUMBER in $OPEN_PRS; do
            if [ -z "$PR_NUMBER" ]; then
              continue
            fi
            
            echo "ğŸ” Checking PR #$PR_NUMBER"
            
            # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸° (curl ì‚¬ìš©)
            PR_INFO=$(curl -s \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER")
            
            if command -v jq >/dev/null 2>&1; then
              PR_BASE=$(echo "$PR_INFO" | jq -r '.base.ref')
              PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
              PR_URL=$(echo "$PR_INFO" | jq -r '.html_url')
              PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.user.login')
              PR_HEAD_REF=$(echo "$PR_INFO" | jq -r '.head.ref')
            else
              # jq ì—†ì´ ê°„ë‹¨ íŒŒì‹±
              PR_BASE=$(echo "$PR_INFO" | grep -o '"base":{"[^}]*"ref":"[^"]*"' | sed 's/.*"ref":"\([^"]*\)".*/\1/')
              PR_TITLE=$(echo "$PR_INFO" | grep -o '"title":"[^"]*"' | cut -d'"' -f4)
              PR_URL=$(echo "$PR_INFO" | grep -o '"html_url":"[^"]*"' | cut -d'"' -f4)
              PR_AUTHOR=$(echo "$PR_INFO" | grep -o '"login":"[^"]*"' | head -1 | cut -d'"' -f4)
              PR_HEAD_REF=$(echo "$PR_INFO" | grep -o '"head":{"[^}]*"ref":"[^"]*"' | sed 's/.*"ref":"\([^"]*\)".*/\1/')
            fi
            
            # í‘¸ì‹œëœ ë¸Œëœì¹˜ê°€ PRì˜ ë² ì´ìŠ¤ ë¸Œëœì¹˜ì™€ ê°™ì€ì§€ í™•ì¸
            if [ "$PR_BASE" != "${{ github.ref_name }}" ]; then
              echo "â­ï¸ Skipping PR #$PR_NUMBER (base: $PR_BASE, pushed: ${{ github.ref_name }})"
              continue
            fi
            
            echo "ğŸ“ PR #$PR_NUMBER: $PR_TITLE (by $PR_AUTHOR)"
            echo "ğŸŒ¿ Head branch: $PR_HEAD_REF, Base branch: $PR_BASE"
            
            # PR ë¸Œëœì¹˜ í˜ì¹˜ (refs/pull/PR_NUMBER/head ì‚¬ìš©)
            if git fetch origin "refs/pull/$PR_NUMBER/head:pr-$PR_NUMBER" 2>/dev/null; then
              git checkout pr-$PR_NUMBER 2>/dev/null
              
              # ì¶©ëŒ í™•ì¸
              if git fetch origin "$PR_BASE" 2>/dev/null; then
                MERGE_BASE=$(git merge-base pr-$PR_NUMBER "origin/$PR_BASE" 2>/dev/null || echo "")
                
                if [ -n "$MERGE_BASE" ]; then
                  CONFLICTS=$(git merge-tree "$MERGE_BASE" pr-$PR_NUMBER "origin/$PR_BASE" 2>/dev/null | grep -c "<<<<<<< " || echo "0")
                  
                  if [ "$CONFLICTS" -gt "0" ]; then
                    echo "âš ï¸ Conflicts detected in PR #$PR_NUMBER: $PR_TITLE"
                    
                    # ì¶©ëŒëœ PR ëª©ë¡ì— ì¶”ê°€
                    if [ -z "$CONFLICTED_PRS" ]; then
                      CONFLICTED_PRS="$PR_NUMBER"
                    else
                      CONFLICTED_PRS="$CONFLICTED_PRS,$PR_NUMBER"
                    fi
                    
                    # ê°œë³„ PR ì•ŒëŒ ë°œì†¡
                    ESCAPED_TITLE=$(echo "$PR_TITLE" | sed 's/"/\\"/g')
                    curl -X POST "${{ secrets.WEBHOOK_URL }}" \
                      -H "Content-Type: application/json" \
                      -d "{
                        \"event_type\": \"push_caused_conflict\",
                        \"pr_number\": $PR_NUMBER,
                        \"pr_url\": \"$PR_URL\",
                        \"pr_title\": \"$ESCAPED_TITLE\",
                        \"pr_author\": \"$PR_AUTHOR\",
                        \"base_branch\": \"$PR_BASE\",
                        \"push_author\": \"${{ github.actor }}\",
                        \"push_commit\": \"${{ github.sha }}\",
                        \"push_message\": \"${{ github.event.head_commit.message }}\",
                        \"repository\": \"${{ github.repository }}\"
                      }" 2>/dev/null || echo "âš ï¸ Failed to send webhook for PR #$PR_NUMBER"
                  else
                    echo "âœ… No conflicts in PR #$PR_NUMBER: $PR_TITLE"
                  fi
                else
                  echo "âŒ Could not find merge base for PR #$PR_NUMBER"
                fi
              else
                echo "âŒ Could not fetch base branch $PR_BASE for PR #$PR_NUMBER"
              fi
              
              # ë‹¤ìŒ PR í™•ì¸ì„ ìœ„í•´ ì •ë¦¬
              git checkout "${{ github.ref_name }}" 2>/dev/null
              git branch -D pr-$PR_NUMBER 2>/dev/null || true
            else
              echo "âŒ Could not fetch PR #$PR_NUMBER branch"
            fi
          done
          
          # ì „ì²´ ìš”ì•½ ì•ŒëŒ (ì¶©ëŒëœ PRì´ ìˆëŠ” ê²½ìš°)
          if [ -n "$CONFLICTED_PRS" ]; then
            echo "ğŸ“Š Summary: Conflicts found in PRs: $CONFLICTED_PRS"
            
            ESCAPED_MESSAGE=$(echo "${{ github.event.head_commit.message }}" | sed 's/"/\\"/g')
            curl -X POST "${{ secrets.WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"event_type\": \"push_conflict_summary\",
                \"conflicted_prs\": \"$CONFLICTED_PRS\",
                \"total_conflicted\": $(echo $CONFLICTED_PRS | tr ',' '\n' | wc -l),
                \"push_author\": \"${{ github.actor }}\",
                \"push_branch\": \"${{ github.ref_name }}\",
                \"push_commit\": \"${{ github.sha }}\",
                \"push_message\": \"$ESCAPED_MESSAGE\",
                \"repository\": \"${{ github.repository }}\"
              }" 2>/dev/null || echo "âš ï¸ Failed to send summary webhook"
          else
            echo "ğŸ‰ No conflicts found in any open PRs"
          fi
          